# 認証/認可・監査

## 1. 認証/認可（将来の運用を見据えた方針）

- Bot 経由の操作：
  - Discord の権限（管理者等）を Bot が確認し、**API にもコンテキストを渡す**
  - API 側でも最低限の検証（guildId の妥当性、必要な権限情報の検証）を行う
- WebUI：
  - Discord OAuth2 を想定
  - API はアクセストークン（またはセッション）に基づいて認証する
- GuildMemberSettings の認可:
  - `Actor.userId` と `:userId` の一致を API 側で必須とする（フェーズ1では本人のみ操作可）

※ 初期は簡略化しても良いが、最終的に「API が認可の正」となるように寄せる。

## 2. ロギング/監査

- apps/api はリクエストログを記録する（開発時は詳細、本番は個人情報に配慮）。
- 設定変更や辞書更新は「誰が/いつ/何を」変更したかを監査ログとして残す（フェーズ1から必須）。
- 監査ログは更新系 API のみで保存する（GET/閲覧は対象外）。
- 監査ログは API 内で同期的に追記し、追記失敗時は API は成功を返す（運用で検知・補完する）。
- 変更が複数ある場合は「変更ごとに 1 ログ」を作成する（同一時刻・同一 entityId）。
- 同一リクエスト内のログ順は `path` の辞書順で安定化し、`path = null` は末尾に置く。
- 差分抽出はネストまで含む深い比較とし、`path` は "a.b.c" 形式で記録する。
- `createdAt` は `X-Yomicord-Actor-Occurred-At` を優先し、未指定時は API 時刻とする。
- 監査ログ追記失敗時の運用手順は `docs/runbooks/audit-log.md` に記載する。

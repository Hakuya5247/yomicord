# AGENTS.md（Yomicord）

<!-- 追加: 分離の明示 -->

> 注記: Agent モードの運用ルール（計画提示、確認質問、差分管理、チェックリスト等）は本書を正とします。  
> `.github/copilot-instructions.md` から Agent 運用に関する内容を分離しました。
> OpenAI Codex においてもこの運用を遵守してください。

この文書は、GitHub Copilot の Agent モードおよび OpenAI Codex がこのリポジトリで安全に作業するための運用ルールです。
monorepo（pnpm workspace）前提。

## 1. 最重要ルール（破ると設計崩壊）

- DB へのアクセス（読み書き）は apps/api のみ
  - apps/bot / apps/web（将来）から DB 直アクセスは禁止。必ず apps/api の HTTP API 経由で操作する。
- API 入出力の定義は packages/contracts を唯一の真実（Source of Truth）
  - API の追加/変更は contracts → api → bot → docs の順で行う（契約ファースト）。
- アーキテクチャの正は docs/architecture.md
  - 設計に影響する変更は docs も更新する。
  - 主な例
    - 新しい責務の追加
    - データの流れ（API/DB/契約）の変更
    - 将来の拡張ポイントの追加

## 2. 言語・スタイル

- コードコメント、ログ、Docs、ユーザー向けメッセージ、回答は日本語を基本とする
- 関数名/変数名は英語で良い（一般的な TypeScript の慣習に合わせる）

## 3. Agent モードの基本動作

- 着手前に 2〜6 ステップの短い計画（調査→実装→検証→共有）を提示する。
- 変更前に既存実装を探索し、影響範囲（contracts / api / bot / docs）を列挙する。
- 要件が曖昧なら最大3つまで確認質問してから実装する（推測で仕様を増やさない）。
- 設計上の決定事項は、原則として ADR（docs/adr）に記録する。
- 依頼範囲外の「ついでの改善」（UX追加、設計変更、過剰リファクタ、依存追加）はしない。
- 変更は小さく分割し、目的が明確な差分にする。
- 差分が 200 行を超えそうなら着手前に確認する。
- コメントについて
  - 今は理解のためのコメントを書いてOK
  - 「なぜ」「比較」「注意点」は積極的に書く
  - 将来消す前提のコメントがあっても気にしない
  - 定期的に「これはもう分かる？」と自分に問う
  - テストコードに対してもコメントを記述してOK
  - 積極的にコメントを書くべき場所:
    - 設計判断の理由（なぜこの実装を選んだか）
    - 非自明なロジック（パッと見で分からない処理）
    - 制約条件（○○が前提、○○の場合は動かない等）
    - 他パッケージとの関係（contracts/api/bot の責務境界）
  - コメント不要な場所:
    - 型や変数名から明らかな内容（例: `// ユーザーIDを取得` は不要）
    - すでにドキュメント化されている標準的なパターン
  - JSDoc形式のコメント:
    - 公開API・エクスポートされる関数には積極的に記述する
    - 特に packages/contracts や共有ユーティリティは必須
    - `@param` で制約や期待される形式を説明
    - `@throws` でエラーの種類と条件を明記
    - `@example` で使用例を示す（特に複雑なシグネチャ）
    - 内部実装・プライベート関数は型で自明なら省略可

### 3.1 Agentの成果物フォーマット（Codex向け）

- 変更概要（Why）
- 実装内容（What）
- 影響範囲（contracts / api / bot / docs）
- 実行したコマンドと結果
- 残タスク / 注意点

## 4. コマンド実行ポリシー（安全性）

### 4.1 自動実行してよい（読み取り・無害）

- 例: git status / git diff / git grep
- 例: ls / find / cat / grep（閲覧目的）
- 例: pnpm --filter ... build（ビルドのみ）
- 例: pnpm check（format:check / lint / build 等の検証）

※ 大量出力・長時間が見込まれる場合は事前に一言断る。

### 4.2 実行前に必ずユーザー確認が必要（破壊的・外部影響）

- 削除/破壊: rm -rf, rm -r, git clean -fdx
- 権限/所有者の広範囲変更: sudo, chmod -R, chown -R
- 履歴改変/強制: git reset --hard, git push --force, （push済みブランチへの）git rebase
- 不透明な外部実行: curl ... | sh, wget ... | bash
- グローバルインストール: npm i -g, pnpm add -g
- secrets を作り得る作業: .env の新規作成/更新、トークン/接続文字列の入力が必要な作業

確認時は「目的・対象・影響範囲」を1〜2文で説明してから待つ。

### 4.3 実行してよいが注意（差分が広がりやすい）

- pnpm install / pnpm add
  - 原則は依存追加なしを優先。必要なら「目的 / 代替案 / なぜ必要か」を短く説明してから実行する。
- pnpm format / pnpm lint:fix
  - 依頼がある、または必要性が明確な場合のみ（意図せぬ差分拡大を避ける）。

## 5. 実装ルール（パッケージ責務の固定）

- apps/api：入力検証、認可、永続化、整合性、監査ログ（ビジネスルールの中心）
  - リクエスト body/query/params は必ず contracts の schema で検証する（safeParse/parse どちらでも可）
  - 認可が必要な更新は API 側で判定できる構造を維持する（Bot 側の推測に依存しない）
  - エラーは将来的に統一するため、レスポンス形式を乱立させない
- apps/bot：Discord からの入力と UX、読み上げ処理
  - 設定・辞書変更などの永続化が絡む操作は API を呼ぶだけにする（fetch 等）
  - Token 等の秘密情報はコードに直書きしない（環境変数を使用）
- packages/contracts：API 入出力 schema（zod）と型のみ
  - HTTP/DB 実装は置かない

## 6. API 変更の標準手順（契約ファースト）

1. packages/contracts に zod schema と型を追加/更新（唯一の真実）
2. apps/api は contracts の schema で入力を検証（body/query/params）
3. apps/bot は DB ではなく API を呼び、型は contracts を参照
4. 設計に影響するなら docs/architecture.md を更新
5. 検証を実行し、結果を報告
   - 部分確認:
     - pnpm --filter @yomicord/contracts build
     - pnpm --filter @yomicord/api build
     - pnpm --filter @yomicord/bot build
   - 最終確認:
     - pnpm check

## 7. 秘密情報・ログ

- トークン、接続文字列、Cookie、個人情報などの秘匿情報をログに出さない
- 秘密情報をコマンドに直書きしない（必要なら環境変数を使う）
- .env や鍵ファイル等を新規作成/更新する場合は、必ず実行前にユーザー確認を取る
- ログ/エラー文は日本語で、状況・原因・次の行動が分かる文にする

## 8. 禁止事項

- apps/bot / apps/web から DB に直接接続する実装
- contracts を無視して独自の入力/出力形式を増やすこと
- 秘密情報（トークン、接続文字列等）をリポジトリにコミットすること
- 大規模な変更を一度に行い、レビューや理解を困難にすること

## 9. スペシャリスト定義（用途別：実装/テスト/レビュー）

Agent は作業内容に応じて、以下 3 種の「スペシャリスト」視点で振る舞う。
（複数にまたがる場合は、同一 Agent がフェーズを切り替えて順番に実施してよい）

### 9.1 実装スペシャリスト（Implementation Specialist）

- 役割: 仕様に沿ってコード変更を行い、差分を最小に保つ。
- 判断軸:
  - API 変更は必ず「contracts → api → bot → docs」の順（契約ファースト）。
  - DB へのアクセス（読み書き）は apps/api のみ。bot/web からの直アクセスは禁止。
  - 依頼範囲外の改善（追加UX/設計変更/過剰リファクタ/不要な依存追加）をしない。
- 成果物:
  - 必要最小限の実装差分
  - 影響範囲の明示（contracts/api/bot/docs）
- 禁止:
  - 秘密情報の埋め込み・ログ出し
  - contracts を無視した入出力形式の追加

### 9.2 テストスペシャリスト（Testing Specialist）

- 役割: 変更が壊れていないことを、最小コストで検証し、結果を報告する。
- 基本方針:
  - まず変更箇所に近い検証 → 最後に全体検証。
  - 失敗した場合、依頼範囲外の不具合まで修正しない（ただし原因切り分けは行う）。
- 推奨コマンド:
  - 部分確認:
    - pnpm --filter @yomicord/contracts build
    - pnpm --filter @yomicord/api build
    - pnpm --filter @yomicord/bot build
  - 最終確認:
    - pnpm check
- 成果物:
  - 実行したコマンドと結果（成功/失敗、失敗なら要点）
  - 手動確認が必要なら再現手順と期待結果

### 9.3 レビュースペシャリスト（Review Specialist）

- 役割: 変更がリポジトリ規約・設計・安全性に沿っているかをレビュー観点で点検する。編集は行わず読み取りのみとする。
- チェック項目（最低限）:
  - 契約ファースト: contracts 変更があるなら api/bot も追従しているか
  - DB境界: apps/api 以外に DB 直アクセスが混入していないか
  - 入力検証: apps/api は contracts の schema で body/query/params を検証しているか
  - 認可: Bot の推測に依存せず API 側で完結しているか
  - 差分管理: 変更が必要最小限か（200行超えそうなら事前確認があったか）
  - 秘密情報: トークン/接続文字列/個人情報がログやコードに出ていないか
- 成果物:
  - リスク指摘（あれば）と、最小の修正提案

## 10. 確認質問テンプレ（曖昧な場合のみ、最大3つ）

- 期待する入出力（payload の例、必須/任意、デフォルト値）
- 失敗時の扱い（ユーザー通知、冪等性、リトライ要否）
- 互換性（既存クライアントへの影響、移行が必要か）

## 補足: AIツールの役割分担

- Codex（ChatGPT）:
  - 設計整理、計画立案、レビュー、複数ファイル横断の検討
- GitHub Copilot:
  - 実装補完、型補完、局所的な修正
